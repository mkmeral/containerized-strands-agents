<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Containerized Strands Agents</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }
        
        .sidebar-header h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .filter-controls {
            margin-top: 10px;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .filter-checkbox input[type="checkbox"] {
            margin: 0;
        }
        
        .new-agent-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            margin: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .new-agent-btn:hover {
            background: #218838;
        }
        
        .new-agent-btn::before {
            content: '+';
            font-size: 18px;
            font-weight: bold;
        }
        
        .agents-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .agent-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-item:hover {
            background: #e9ecef;
        }
        
        .agent-item.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .agent-info {
            flex: 1;
        }
        
        .agent-id {
            font-weight: 500;
            font-size: 14px;
        }
        
        .agent-status {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-running {
            background: #28a745;
            color: white;
        }
        
        .status-stopped {
            background: #6c757d;
            color: white;
        }
        
        .status-error {
            background: #dc3545;
            color: white;
        }
        
        .status-processing {
            background: #ffc107;
            color: black;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .message.tool_use,
        .message.tool_result {
            margin-bottom: 4px;
        }
        
        .message.tool_use .message-content,
        .message.tool_result .message-content {
            background: transparent;
            border: none;
            padding: 2px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .message.tool_use .message-header,
        .message.tool_result .message-header {
            display: none;
        }
        
        .tool-icon {
            font-size: 12px;
            color: #6c757d;
        }
        
        .tool-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tool-badge.tool-name {
            background: #e9ecef;
            color: #495057;
        }
        
        .tool-badge.status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .tool-badge.status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tool-badge.status-unknown {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }
        
        .no-agent {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 18px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .message-header {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .message-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            white-space: pre-wrap;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
        }
        
        .message.user .message-content {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            min-height: 60px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .send-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
            align-self: flex-end;
        }
        
        .send-btn:hover {
            background: #0056b3;
        }
        
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .options-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .option-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px;
            border: 1px solid #f5c6cb;
        }
        
        .new-agent-form {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }
        
        .form-header {
            padding: 20px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .form-header h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .form-header p {
            color: #6c757d;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-textarea.large {
            min-height: 120px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 20px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .form-help {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .main-content {
                height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Agents</h1>
            <div class="header-controls">
                <button class="refresh-btn" onclick="loadAgents()">Refresh</button>
            </div>
            <div class="filter-controls">
                <label class="filter-checkbox">
                    <input type="checkbox" id="show-all-agents" onchange="toggleShowAllAgents()">
                    Show all agents (including old)
                </label>
            </div>
        </div>
        <button class="new-agent-btn" onclick="showNewAgentForm()">New Agent</button>
        <div class="agents-list" id="agents-list">
            <div class="loading">Loading agents...</div>
        </div>
    </div>
    
    <div class="main-content">
        <div id="no-agent" class="no-agent">
            Select an agent to start chatting
        </div>
        
        <div id="chat-container" class="chat-container" style="display: none;">
            <div class="chat-header">
                <h2 id="chat-title">Agent Chat</h2>
            </div>
            
            <div class="messages-area" id="messages-area">
                <div class="loading">Loading messages...</div>
            </div>
            
            <div class="input-area">
                <div class="input-row">
                    <textarea 
                        id="message-input" 
                        class="message-input" 
                        placeholder="Type your message..."
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()" id="send-btn">Send</button>
                </div>
                
                <div class="options-row">
                    <input 
                        type="text" 
                        id="aws-profile" 
                        class="option-input" 
                        placeholder="AWS Profile (optional)"
                    />
                    <input 
                        type="text" 
                        id="aws-region" 
                        class="option-input" 
                        placeholder="AWS Region (optional)"
                    />
                    <input 
                        type="text" 
                        id="system-prompt" 
                        class="option-input" 
                        placeholder="System Prompt (new agents only)"
                    />
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAgentId = null;
        let refreshInterval = null;
        let messagesInterval = null;
        let allAgents = []; // Store all agents for filtering
        
        // Auto-refresh every 3 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadAgents();
                if (currentAgentId) {
                    loadMessages(currentAgentId);
                }
            }, 3000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (messagesInterval) {
                clearInterval(messagesInterval);
                messagesInterval = null;
            }
        }
        
        // Load agents from API
        async function loadAgents() {
            try {
                const response = await fetch('/agents');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allAgents = data.agents; // Store all agents
                    renderAgents(getFilteredAndSortedAgents());
                } else {
                    showError('Failed to load agents');
                }
            } catch (error) {
                showError('Error loading agents: ' + error.message);
            }
        }
        
        // Get filtered and sorted agents based on current settings
        function getFilteredAndSortedAgents() {
            const showAll = document.getElementById('show-all-agents').checked;
            let agents = [...allAgents];
            
            // Filter out old agents (older than 7 days) if not showing all
            if (!showAll) {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                agents = agents.filter(agent => {
                    if (!agent.last_activity) {
                        // If no last_activity, include only if created recently
                        if (!agent.created_at) return true;
                        const createdAt = new Date(agent.created_at);
                        return createdAt > sevenDaysAgo;
                    }
                    
                    const lastActivity = new Date(agent.last_activity);
                    return lastActivity > sevenDaysAgo;
                });
            }
            
            // Sort by last_activity (newest first)
            agents.sort((a, b) => {
                const aTime = a.last_activity ? new Date(a.last_activity) : 
                             a.created_at ? new Date(a.created_at) : new Date(0);
                const bTime = b.last_activity ? new Date(b.last_activity) : 
                             b.created_at ? new Date(b.created_at) : new Date(0);
                return bTime - aTime; // Descending order (newest first)
            });
            
            return agents;
        }
        
        // Toggle show all agents
        function toggleShowAllAgents() {
            renderAgents(getFilteredAndSortedAgents());
        }
        
        // Render agents in sidebar
        function renderAgents(agents) {
            const agentsList = document.getElementById('agents-list');
            
            if (agents.length === 0) {
                const showAll = document.getElementById('show-all-agents').checked;
                const message = showAll ? 'No agents found' : 'No recent agents found (toggle "Show all agents" to see older ones)';
                agentsList.innerHTML = `<div class="loading">${message}</div>`;
                return;
            }
            
            agentsList.innerHTML = agents.map(agent => {
                const lastActivityText = formatLastActivity(agent.last_activity || agent.created_at);
                
                return `
                    <div class="agent-item ${agent.agent_id === currentAgentId ? 'active' : ''}" 
                         onclick="selectAgent('${agent.agent_id}')">
                        <div class="agent-info">
                            <div class="agent-id">${agent.agent_id}</div>
                            <div class="agent-status">
                                <span class="status-badge status-${agent.status}">${agent.status}</span>
                                ${agent.processing ? '<span class="status-badge status-processing">Processing</span>' : ''}
                            </div>
                            <div class="agent-status" style="margin-top: 4px; font-size: 11px;">
                                Last active: ${lastActivityText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Format last activity time for display
        function formatLastActivity(dateString) {
            if (!dateString) return 'Unknown';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Select an agent
        async function selectAgent(agentId) {
            currentAgentId = agentId;
            
            // Update UI
            document.getElementById('no-agent').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            document.getElementById('chat-title').textContent = `Chat with ${agentId}`;
            
            // Update active agent in sidebar (re-render with current filter)
            renderAgents(getFilteredAndSortedAgents());
            
            // Load messages
            await loadMessages(agentId);
        }
        
        // Load messages for current agent
        async function loadMessages(agentId) {
            try {
                const response = await fetch(`/agents/${agentId}/messages?count=20`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderMessages(data.messages);
                } else if (response.status === 404) {
                    // Agent doesn't exist yet, show empty chat
                    renderMessages([]);
                } else {
                    showError('Failed to load messages');
                }
            } catch (error) {
                showError('Error loading messages: ' + error.message);
            }
        }
        
        // Render messages - handles raw Strands message format
        function renderMessages(messages) {
            const messagesArea = document.getElementById('messages-area');
            
            if (messages.length === 0) {
                messagesArea.innerHTML = '<div class="loading">No messages yet. Send a message to start the conversation.</div>';
                return;
            }
            
            // Process raw Strands messages into display format
            const displayMessages = [];
            for (const msg of messages) {
                const content = msg.content || [];
                
                if (msg.role === 'user') {
                    // Check for tool_result in content
                    const toolResult = Array.isArray(content) && content.find(c => c.type === 'tool_result' || c.toolResult);
                    if (toolResult) {
                        const result = toolResult.toolResult || toolResult;
                        const status = result.status || (result.is_error ? 'error' : 'success');
                        displayMessages.push({ type: 'tool_result', status });
                    } else {
                        // Regular user message
                        const text = extractText(content);
                        if (text) displayMessages.push({ type: 'user', content: text });
                    }
                } else if (msg.role === 'assistant') {
                    // Extract text and tool_use from content
                    if (Array.isArray(content)) {
                        let text = '';
                        for (const item of content) {
                            if (item.type === 'text' || item.text) {
                                text += (item.text || '') + '\n';
                            } else if (item.type === 'tool_use' || item.toolUse) {
                                // Add any accumulated text first
                                if (text.trim()) {
                                    displayMessages.push({ type: 'assistant', content: text.trim() });
                                    text = '';
                                }
                                const toolData = item.toolUse || item;
                                displayMessages.push({ type: 'tool_use', tool: toolData.name || 'unknown' });
                            }
                        }
                        // Add remaining text
                        if (text.trim()) {
                            displayMessages.push({ type: 'assistant', content: text.trim() });
                        }
                    } else if (typeof content === 'string') {
                        displayMessages.push({ type: 'assistant', content });
                    }
                }
            }
            
            messagesArea.innerHTML = displayMessages.map(msg => {
                if (msg.type === 'tool_use') {
                    return `
                        <div class="message tool_use">
                            <div class="message-content">
                                <span class="tool-icon">⚙️</span>
                                <span class="tool-badge tool-name">${escapeHtml(msg.tool)}</span>
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'tool_result') {
                    const statusClass = msg.status === 'success' ? 'status-success' : 
                                       msg.status === 'error' ? 'status-error' : 'status-unknown';
                    const icon = msg.status === 'success' ? '✓' : msg.status === 'error' ? '✗' : '?';
                    return `
                        <div class="message tool_result">
                            <div class="message-content">
                                <span class="tool-icon" style="margin-left: 22px;">↳</span>
                                <span class="tool-badge ${statusClass}">${icon}</span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="message ${msg.type}">
                            <div class="message-header">${msg.type.toUpperCase()}</div>
                            <div class="message-content">${escapeHtml(msg.content || '')}</div>
                        </div>
                    `;
                }
            }).join('');
            
            // Auto-scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        // Extract text from Strands content array
        function extractText(content) {
            if (typeof content === 'string') return content;
            if (!Array.isArray(content)) return '';
            return content
                .filter(c => c.type === 'text' || c.text)
                .map(c => c.text || '')
                .join('\n');
        }
        
        // Send message
        async function sendMessage() {
            if (!currentAgentId) return;
            
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Get optional parameters
            const awsProfile = document.getElementById('aws-profile').value.trim() || null;
            const awsRegion = document.getElementById('aws-region').value.trim() || null;
            const systemPrompt = document.getElementById('system-prompt').value.trim() || null;
            
            // Disable input
            messageInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch(`/agents/${currentAgentId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        aws_profile: awsProfile,
                        aws_region: awsRegion,
                        system_prompt: systemPrompt
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'dispatched' || data.status === 'queued') {
                    // Clear input
                    messageInput.value = '';
                    
                    // Immediately add user message to UI
                    addMessageToUI('user', message);
                    
                    // Start polling for response
                    pollForResponse();
                } else {
                    showError(data.error || 'Failed to send message');
                }
            } catch (error) {
                showError('Error sending message: ' + error.message);
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                messageInput.focus();
            }
        }
        
        // Add message to UI immediately
        function addMessageToUI(role, content) {
            const messagesArea = document.getElementById('messages-area');
            
            // If no messages, clear loading text
            if (messagesArea.innerHTML.includes('No messages yet')) {
                messagesArea.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-header">${role.toUpperCase()}</div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        // Poll for response after sending message
        function pollForResponse() {
            let attempts = 0;
            const maxAttempts = 40; // 2 minutes at 3 second intervals
            
            const poll = async () => {
                attempts++;
                
                try {
                    const response = await fetch(`/agents/${currentAgentId}/messages?count=1`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.messages.length > 0) {
                        const lastMessage = data.messages[data.messages.length - 1];
                        
                        // Check if this is a new assistant message
                        const messagesArea = document.getElementById('messages-area');
                        const lastDisplayed = messagesArea.querySelector('.message:last-child .message-header');
                        
                        if (lastMessage.role === 'assistant' && 
                            (!lastDisplayed || !lastDisplayed.textContent.includes('ASSISTANT'))) {
                            // Load all messages to get complete conversation
                            loadMessages(currentAgentId);
                            return; // Stop polling
                        }
                    }
                    
                    // Continue polling if not processing and within attempt limit
                    if (!data.processing && attempts < maxAttempts) {
                        setTimeout(poll, 3000);
                    } else if (attempts >= maxAttempts) {
                        showError('Response timeout. The agent may be taking longer than expected.');
                    } else {
                        // Still processing, continue polling
                        setTimeout(poll, 3000);
                    }
                } catch (error) {
                    console.error('Error polling for response:', error);
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 3000);
                    }
                }
            };
            
            // Start polling after a short delay
            setTimeout(poll, 1000);
        }
        
        // Handle Enter key in message input
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Show error message
        function showError(message) {
            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = message;
            document.body.appendChild(error);
            
            setTimeout(() => {
                error.remove();
            }, 5000);
        }
        
        // Show new agent form (placeholder - can be enhanced later)
        function showNewAgentForm() {
            alert('New agent creation form would be implemented here. For now, agents are created automatically when you send a message to a new agent ID.');
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAgents();
            startAutoRefresh();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>